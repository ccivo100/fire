[#include "/app/common/layout/__frontmainlayout.html"/]

[#assign pageCss]
<link rel="stylesheet" href="${ContextPath}/admin/assets/css/signin.css" />
<link rel="stylesheet" href="${ContextPath}/admin/assets/css/chosen.css" />
<link rel="stylesheet" href="${ContextPath}/admin/assets/css/jquery-ui.css" />
[/#assign]

[#assign pageJavascript]
<script src="${ContextPath}/admin/assets/js/jquery-ui.js"></script>
<script src="${ContextPath}/admin/assets/js/chosen.jquery.js"></script>
<script type="text/javascript">

/* 异步获取一级故障类别数据 */
function select1() {
	$.ajax(
    {
    	type: "post",
    	url: "${ContextPath}/report/handler",
    	data: { "type": "type" },
        success: function (msg) {
        	$("#selectType").append("<option value='-1'>请选择故障大类</option>");
        	for (var i = 0; i < msg.typeList.length; i++) {
            	$("#selectType").append("<option value=" + msg.typeList[i].id + ">" + msg.typeList[i].name + "</option>");
        	}
            select2();
        }
	})
};
/* 异步获取一级故障类别数据-模板功能 */
function select1ByTemplate() {
	$.ajax(
    {
    	type: "post",
    	url: "${ContextPath}/report/handler",
    	data: { "type": "type" },
        success: function (msg) {
        	$("#selectType2").append("<option value='-1'>请选择故障大类</option>");
        	for (var i = 0; i < msg.typeList.length; i++) {
            	$("#selectType2").append("<option value=" + msg.typeList[i].id + ">" + msg.typeList[i].name + "</option>");
        	}
            select2ByTemplate();
        }
	})
};
/* 异步获取二级故障类别数据-模板功能 */
function select2ByTemplate() {
	$("#selectChildType2").html("");    //清除二级故障数据
	$("#selectTemplate").html("");    //清除模板数据
	$.ajax(
	{
		type: "post",
		url: "${ContextPath}/report/handler",
		data: { "type": "template","typeid":$('#selectType2').val() },
		success: function (msg) {
			$("#selectChildType2").append("<option value='-1'>请选择故障小类</option>");
			$("#selectTemplate").append("<option value='-1'>请选择模板类型</option>");
			
			for (var i = 0; i < msg.childTypeList.length; i++) {
				$("#selectChildType2").append("<option value=" + msg.childTypeList[i].id + ">" +msg.childTypeList[i].name + "</option>");
			}
			for (var i = 0; i < msg.templateList.length; i++) {
				$("#selectTemplate").append("<option value=" + msg.templateList[i].id + ">" +msg.templateList[i].title + "</option>");
			}
			select3ByTemplate();
		}
	})
};

function select3ByTemplate(){
	$("#description2").html("");    //清除二级故障数据
	$("#userListTitle").html("");    //清除标题
	$("#userList").html("");    //清除接收人员数据
	$.ajax(
	{
		type: "post",
		url: "${ContextPath}/report/handler",
		data: { "type": "setValue","selectTemplateid":$('#selectTemplate').val() },
		success: function (msg) {
			if(msg.template){
				$("#description2").text(msg.template.context);
				$("#userListTitle").append("接收人员：");
				for (var i = 0; i < msg.userList.length; i++) {
					$("#userList").append("<span class='label label-success'>"+ msg.userList[i].full_name + "</span> ");
				}
			}else{
			}
		}
	})
};

/* 异步获取一级部门、二级故障类别数据 */
function select2() {
	$("#selectMail").html("");    //清除接收邮件人员
	$("#selectSms").html("");    //清除接收短信人员
	$("#selectApartment").html("");    //清除一级部门数据
	$("#selectChildType").html("");    //清除二级故障数据
	
	var apartmentArray=new Array();    //判断选择的一级部门数量，是否显示二级部门。
	$("#selectApartment option:selected").each(function(i){ 
			apartmentArray[i]=$(this).val(); 
	});
	if(apartmentArray.length>1){
		$('#childdiv').hide();
	}
	if(apartmentArray.length<=1){
		$('#childdiv').show();
	}
	
	$.ajax(
	{
		type: "post",
		url: "${ContextPath}/report/handler",
		data: { "type": "apartment","typeid":$('#selectType').val() },
		success: function (msg) {
			$("#selectChildType").append("<option value='-1'>请选择故障小类</option>");
			for (var i = 0; i < msg.apartmentList.length; i++) {
				$("#selectApartment").append("<option value=" + msg.apartmentList[i].id + ">" +msg.apartmentList[i].name + "</option>");
			}
			
			for (var i = 0; i < msg.childTypeList.length; i++) {
				$("#selectChildType").append("<option value=" + msg.childTypeList[i].id + ">" +msg.childTypeList[i].name + "</option>");
			}
			select3();
		}
	})
};

/* 异步获取二级部门数据，点击二级故障 */
function select3() {
	$("#selectChildApartment").html("");
	$.ajax(
	{
		type: "post",
		url: "${ContextPath}/report/handler",
		data: { "type": "childApartment","childTypeid":$('#selectChildType').val(),"rootApartment": $('#selectApartment').val()},
		success: function (msg) {
			$("#selectChildApartment").append("<option value='-1'>请选择运维组别</option>");
			for (var i = 0; i < msg.childApartmentList.length; i++) {
				$("#selectChildApartment").append("<option value=" + msg.childApartmentList[i].id + ">" +msg.childApartmentList[i].name + "</option>");
			}
		}
	})
};

/* 异步获取二级部门数据，点击一级部门 */
function select4() {
	$("#selectChildApartment").html("");
	
	var apartmentArray=new Array();
	$("#selectApartment option:selected").each(function(i){ 
			apartmentArray[i]=$(this).val(); 
	});
	if(apartmentArray.length>1){
		$('#childdiv').hide();
	}
	if(apartmentArray.length<=1){
		$('#childdiv').show();
	}
	
	$.ajax(
	{
		type: "post",
		url: "${ContextPath}/report/handler",
		data: { "type": "childApartment","childTypeid":$('#selectChildType').val(),"rootApartment": $('#selectApartment').val()},
		success: function (msg) {
			$("#selectChildApartment").append("<option value='-1'>请选择运维组别</option>");
			for (var i = 0; i < msg.childApartmentList.length; i++) {
				$("#selectChildApartment").append("<option value=" + msg.childApartmentList[i].id + ">" +msg.childApartmentList[i].name + "</option>");
			}
		}
	})
};

/* 异步获取接收邮件、短信的人员数据。判断是否选择多个一级部门 */
function selectMailAndSms(){
	$("#selectMail").html("");
	$("#selectSms").html("");
	var apartmentArray=new Array();
	$("#selectApartment option:selected").each(function(i){ 
			apartmentArray[i]=$(this).val(); 
	});
	if(apartmentArray.length>1){
	
		$('#childdiv').hide();
		$.ajax(
		{
			type: "post",
			url: "${ContextPath}/report/handler",
			data: { "type": "mailAndSm", "childTypeid":$('#selectChildType').val(), "selectApartment": $('#selectApartment').val()},
			success: function (msg) {
				for (var i = 0; i < msg.userList.length; i++) {
					$("#selectMail").append("<option value=" + msg.userList[i].id + ">" +msg.userList[i].full_name + "</option>");
					$("#selectSms").append("<option value=" + msg.userList[i].id + ">" +msg.userList[i].full_name + "</option>");
				}
			}
		});
	
	}
	if(apartmentArray.length<=1){
	
		$('#childdiv').show();
		$.ajax(
		{
			type: "post",
			url: "${ContextPath}/report/handler",
			data: { "type": "mailAndSm", "selectApartment": $('#selectApartment').val(), "selectChildApartment": $('#selectChildApartment').val()},
			success: function (msg) {
				for (var i = 0; i < msg.userList.length; i++) {
					$("#selectMail").append("<option value=" + msg.userList[i].id + ">" +msg.userList[i].full_name + "</option>");
					$("#selectSms").append("<option value=" + msg.userList[i].id + ">" +msg.userList[i].full_name + "</option>");
				}
			}
		});
	
	}
}

/* 判断二级部门是否有人。 */
function select5(){
	$.ajax(
	{
		type: "post",
		url: "${ContextPath}/report/handler",
		data: { "type": "effective","apartmentid":$('#selectChildApartment').val() },
		success: function (msg) {
			if(msg.state=="error"){
				alertModal("该分组无运维人员，请选择其他运维组!");
				$('#alertModal').modal();
				select3();
			}
		}
	})
}

/* 数据绑定 */
$(function(){
	select1();
	select1ByTemplate();
	$('#selectType').bind("change", select2);
	$('#selectType2').bind("change",select2ByTemplate);
	$('#selectTemplate').bind("change",select3ByTemplate);
	
	$('#selectChildType').bind("change", select3);
	$('#selectChildType').bind("change",  selectMailAndSms);
	$('#selectApartment').bind("change", select4);
	$('#selectApartment').bind("change",  selectMailAndSms);
	$('#selectChildApartment').bind("change", select5);
	$('#selectChildApartment').bind("change",  selectMailAndSms);
});

function alertModal(msg){
	$("#modal-title-content").html("提示!");  
	$("#modal-body-content").html(msg);  
}
function alertSaveModal(msg){
	$("#modal-title-saveOrder").html("提示!");  
	$("#modal-body-saveOrder").html(msg);  
}

$(".reportsave").click(function(){
	var mailArray=new Array();
	var smsArray=new Array();
	var alertMsg="";
	
	$("#selectMail option:selected").each(function(i){ 
			apartmentArray[i]=$(this).val(); 
	});
	$("#selectSms option:selected").each(function(i){ 
			apartmentArray[i]=$(this).val(); 
	});
	
	if(mailArray.length==0){
		alertMsg+="邮件通知员 ";
	}
	if(smsArray.length==0){
		alertMsg+="短信通知员 ";
	}
	
	alertSaveModal(alertMsg);
	$("#saveModal").modal();
	
});

/* 提交故障工单 */
$(document).ready(function(){
	$("#reportsave").click(function(){
		
		$.ajax({
			type:"post",
			url:"${ContextPath}/report/save",
			data:{
					"selectType":$('#selectType').val(),
					"childTypeid":$('#selectChildType').val(),
					"selectApartment":$('#selectApartment').val(),
					"selectChildApartment":$('#selectChildApartment').val(),
					
					"selectMail":$('#selectMail').val(),
					"selectSms":$('#selectSms').val(),
					
					"order.offer_user":$('#userid').val(),
					"order.title":$('#title').val(),
					"order.description":$('#description').val(),
					"order.type":$('#selectChildType').val(),
					"order.level":$('#selectLevel').val(),
					
			},
			success:function(msg){
				alertModal(msg.state);
				$('#alertModal').modal();
				$('#alertModal').on('hidden.bs.modal', function () {
					if(msg.state=='提交成功！'){
						window.location.href='${ContextPath}/report/reports'
					}
				});
			}
		});
	});
});
$(document).ready(function(){
	$("#reportsave2").click(function(){
		
		$.ajax({
			type:"post",
			url:"${ContextPath}/report/saveByTemplate",
			data:{
					"selectType":$('#selectType2').val(),
					"childTypeid":$('#selectChildType2').val(),
					
					"order.offer_user":$('#userid').val(),
					"order.title":$('#title2').val(),
					"order.description":$('#description2').val(),
					"order.type":$('#selectChildType2').val(),
			        <!-- "selectTemplate":$('#selectTemplate').val(), -->
	          		"order.selectTemplate":$('#selectTemplate').val(),
			},
			success:function(msg){
				alertModal(msg.state);
				$('#alertModal').modal();
				$('#alertModal').on('hidden.bs.modal', function () {
					if(msg.state=='提交成功！'){
						window.location.href='${ContextPath}/report/reports'
					}
				});
			}
		});
	});
});


$( "#tabs" ).tabs();

</script>

[/#assign]

[@mainlayout pageJavascript=pageJavascript pageCss=pageCss currentMenu="offerFlag"]
<div class="index-background">
	
	<form class="form-horizontal" role="form"  action="${ContextPath}/report/save" method="post" >
		[#include "_formadd.html" /]
	</form>
</div>
[/@mainlayout]